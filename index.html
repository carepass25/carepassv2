<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CarePass ‚Äì Your Key to Secure Health Data</title>
    <link rel="icon" href="IMG_20250822_103325.png.png">
  <meta name="description" content="Secure digital health records with NFC technology for patients and healthcare providers. HIPAA compliant medical data management." />
  <meta name="author" content="CarePass Medical" />
  <meta name="keywords" content="digital health, medical records, NFC, healthcare, patient data, secure health, HIPAA compliant" />
  
  <meta property="og:title" content="CarePass ‚Äì Your Key to Secure Health Data" />
  <meta property="og:description" content="Secure digital health records with NFC technology for patients and healthcare providers" />
  <meta property="og:type" content="website" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'medical-blue': {
              DEFAULT: '#3b82f6',
              'light': '#dbeafe',
              'dark': '#1d4ed8'
            },
            'health-green': {
              DEFAULT: '#059669',
              'light': '#dcfce7',
              'dark': '#047857'
            },
            'doctor-purple': {
              DEFAULT: '#7c3aed',
              'light': '#ede9fe',
              'dark': '#5b21b6'
            },
            'emergency-red': {
              DEFAULT: '#dc2626',
              'light': '#fef2f2',
              'dark': '#991b1b'
            }
          },
          backgroundImage: {
            'gradient-medical': 'linear-gradient(135deg, #3b82f6, #60a5fa)',
            'gradient-health': 'linear-gradient(135deg, #059669, #34d399)',
            'gradient-care': 'linear-gradient(135deg, #7c3aed, #a78bfa)',
            'gradient-bg': 'linear-gradient(180deg, #ffffff, #f8fafc)'
          },
          boxShadow: {
            'medical': '0 10px 25px -5px rgba(59, 130, 246, 0.15)',
            'glow': '0 0 20px rgba(96, 165, 250, 0.3)',
            'card': '0 4px 12px -2px rgba(15, 23, 42, 0.08)',
            'emergency': '0 0 20px rgba(220, 38, 38, 0.2)'
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: white;
      min-height: 100vh;
    }
    
    .fade-section {
      opacity: 0;
      transform: scale(0.95);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .fade-section.active {
      opacity: 1;
      transform: scale(1);
    }
    
    .btn-medical {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      transition: all 0.3s ease;
      border-radius: 0.75rem;
      color: white;
      padding: 1.5rem;
      font-weight: 600;
      box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.15);
    }
    .btn-medical:hover {
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
      transform: translateY(-2px);
    }
    
    .btn-health {
      background: linear-gradient(135deg, #059669, #34d399);
      transition: all 0.3s ease;
      border-radius: 0.75rem;
      color: white;
      padding: 1.5rem;
      font-weight: 600;
      box-shadow: 0 10px 25px -5px rgba(5, 150, 105, 0.15);
    }
    .btn-health:hover {
      box-shadow: 0 0 20px rgba(52, 211, 153, 0.3);
      transform: translateY(-2px);
    }
    
    .btn-care {
      background: linear-gradient(135deg, #7c3aed, #a78bfa);
      transition: all 0.3s ease;
      border-radius: 0.75rem;
      color: white;
      padding: 1.5rem;
      font-weight: 600;
      box-shadow: 0 10px 25px -5px rgba(124, 58, 237, 0.15);
    }
    .btn-care:hover {
      box-shadow: 0 0 20px rgba(167, 139, 250, 0.3);
      transform: translateY(-2px);
    }
    
    .btn-nfc {
      background: linear-gradient(135deg, #7c3aed, #a78bfa);
      transition: all 0.3s ease;
      color: white;
      padding: 0.75rem;
      border-radius: 0.75rem;
      min-width: 4rem;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .btn-nfc:hover {
      box-shadow: 0 0 20px rgba(167, 139, 250, 0.3);
      transform: translateY(-1px);
    }
    
    .medical-card {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px -2px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(226, 232, 240, 0.8);
    }
    
    .emergency-section {
      background: linear-gradient(135deg, #fef2f2, #fce7e7);
      border: 2px solid rgba(220, 38, 38, 0.2);
      border-radius: 0.75rem;
    }
    
    .input-field {
      width: 100%;
      border: 2px solid #e5e7eb;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      background: white;
    }
    .input-field:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .select-field {
      width: 100%;
      border: 2px solid #e5e7eb;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      background: white;
      transition: border-color 0.3s ease;
    }
    .select-field:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .textarea-field {
      width: 100%;
      border: 2px solid #e5e7eb;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      resize: vertical;
      transition: border-color 0.3s ease;
      background: white;
      min-height: 100px;
    }
    .textarea-field:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .emergency-input {
      border-color: #dc2626 !important;
    }
    .emergency-input:focus {
      border-color: #dc2626 !important;
    }
    
    .nfc-input-group {
      display: flex;
      gap: 0.5rem;
      align-items: stretch;
    }
    .nfc-input-group input {
      flex: 1;
      min-width: 0;
    }
    
    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      color: white;
      max-width: 20rem;
      z-index: 50;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    .toast.show {
      transform: translateX(0);
    }
    .toast.success { background: #059669; }
    .toast.error { background: #dc2626; }
    .toast.warning { background: #d97706; }
    .toast.info { background: #3b82f6; }
  </style>
</head>
<body class="bg-white min-h-screen">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-2xl shadow-lg flex flex-col items-center space-y-4">
      <div class="spinner"></div>
      <p class="text-gray-700 font-medium text-lg">Processing your request...</p>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <div class="flex items-center space-x-3">
      <div id="toast-icon" class="text-xl"></div>
      <div>
        <div id="toast-title" class="font-semibold"></div>
        <div id="toast-message" class="text-sm opacity-90"></div>
      </div>
    </div>
  </div>

  <!-- Main Menu -->
  <div id="menu-screen" class="min-h-screen flex items-center justify-center p-4 fade-section active bg-white">
    <div class="medical-card w-full max-w-md p-8">
      <div class="text-center mb-8">
        <h1 class="text-5xl font-bold bg-gradient-medical bg-clip-text text-transparent mb-4">
          üíô CarePass
        </h1>
        <p class="text-xl text-gray-600 mb-2">ü©∫ Your Key to Secure Health Data</p>
        <p class="text-sm text-gray-500">Professional Healthcare Management System</p>
      </div>
      
      <div class="space-y-4">
        <button data-target="register" class="btn-medical w-full text-white rounded-xl transition-all duration-300 text-lg font-semibold flex flex-col items-start text-left">
          <div class="flex items-center space-x-2 mb-1">
            <span>üîê</span>
            <span>Create CarePass</span>
          </div>
          <div class="text-sm font-normal opacity-90">Register as Patient or Doctor</div>
        </button>
        
        <button data-target="update" class="btn-health w-full text-white rounded-xl transition-all duration-300 text-lg font-semibold flex flex-col items-start text-left">
          <div class="flex items-center space-x-2 mb-1">
            <span>üìù</span>
            <span>Update Medical Records</span>
          </div>
          <div class="text-sm font-normal opacity-90">Comprehensive Health Information</div>
        </button>
        
        <button data-target="access" class="btn-care w-full text-white rounded-xl transition-all duration-300 text-lg font-semibold flex flex-col items-start text-left">
          <div class="flex items-center space-x-2 mb-1">
            <span>üßë‚Äç‚öïÔ∏è</span>
            <span>Healthcare Provider Access</span>
          </div>
          <div class="text-sm font-normal opacity-90">Secure Patient Record Access</div>
        </button>
      </div>
      
      <div class="mt-8 text-center">
        <div class="flex items-center justify-center space-x-2 text-sm text-gray-500">
          <span>üîí</span>
          <span>End-to-End Encrypted</span>
          <span>‚Ä¢</span>
          <span>HIPAA Compliant</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Container -->
  <main id="content" class="hidden bg-white">

    <!-- Register Section -->
    <section id="register" class="hidden min-h-screen flex items-center justify-center p-4 fade-section bg-white">
      <div class="medical-card w-full max-w-md">
        <div class="p-6 border-b border-gray-100">
          <button class="back-btn text-blue-600 hover:text-blue-700 flex items-center space-x-2 mb-4 transition-colors">
            <span>‚Üê</span><span>Back to Menu</span>
          </button>
          <h2 class="text-2xl font-bold text-center text-gray-800">üîê Create Your CarePass</h2>
          <p class="text-center text-gray-600 mt-2">Join the secure healthcare network</p>
        </div>
        
        <div class="p-6">
          <form id="registerForm" class="space-y-6">
            <div>
              <label class="block font-semibold mb-2 text-gray-700">Role:</label>
              <select name="role" required class="select-field">
                <option value="">Select your role</option>
                <option value="patient">üë§ Patient</option>
                <option value="doctor">üßë‚Äç‚öïÔ∏è Healthcare Provider</option>
              </select>
            </div>
            
            <div>
              <label class="block font-semibold mb-2 text-gray-700">Full Name:</label>
              <input name="name" type="text" required placeholder="Enter your full name" class="input-field" />
            </div>
            
            <div>
              <label class="block font-semibold mb-2 text-gray-700">CarePass ID (NFC Security):</label>
              <div class="nfc-input-group">
                <input id="carePassIdInputReg" name="carePassId" type="password" required 
                       placeholder="Tap NFC card or enter secure ID" class="input-field" />
                <button type="button" id="scanNfcBtnReg" class="btn-nfc text-white rounded-xl transition-all">
                  <span class="hidden sm:inline">üì° NFC</span>
                  <span class="sm:hidden">üì°</span>
                </button>
              </div>
              <p class="text-sm text-gray-500 mt-2">üîí Your secure healthcare identifier</p>
            </div>
            
            <button type="submit" class="btn-medical w-full text-white px-6 py-4 rounded-xl text-lg font-semibold transition-all">
              Create Secure CarePass
            </button>
          </form>
        </div>
      </div>
    </section>

    <!-- Update Section -->
    <section id="update" class="hidden min-h-screen p-4 fade-section bg-white">
      <div class="max-w-4xl mx-auto">
        <div class="medical-card">
          <div class="p-6 border-b border-gray-100">
            <button class="back-btn text-blue-600 hover:text-blue-700 flex items-center space-x-2 mb-4 transition-colors">
              <span>‚Üê</span><span>Back to Menu</span>
            </button>
            <h2 class="text-3xl font-bold text-center text-gray-800">üìù Update Medical Records</h2>
            <p class="text-center text-gray-600 mt-2">Comprehensive Health Information Management</p>
          </div>
          
          <div class="p-6">
            <form id="updateForm" class="space-y-8">
              <!-- NFC Scanner -->
              <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                <label class="block font-semibold mb-3 text-gray-800">üîê CarePass Authentication:</label>
                <div class="nfc-input-group">
                  <input id="carePassIdInputUpd" name="carePassId" type="password" required 
                         placeholder="Tap NFC card or enter your CarePass ID" class="input-field" />
                  <button type="button" id="scanNfcBtnUpd" class="btn-nfc text-white rounded-xl transition-all">
                    <span class="hidden sm:inline">üì° NFC</span>
                    <span class="sm:hidden">üì°</span>
                  </button>
                </div>
              </div>

              <!-- Personal Information -->
              <div class="space-y-6">
                <h3 class="text-xl font-bold text-gray-800 border-b border-gray-200 pb-2">üë§ Personal Information</h3>
                
                <div>
                  <label class="block font-semibold mb-2 text-gray-700">Full Legal Name:</label>
                  <input name="fullName" type="text" placeholder="Full Legal Name" class="input-field" />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block font-semibold mb-2 text-gray-700">Date of Birth:</label>
                    <input name="dob" type="date" class="input-field" />
                  </div>
                  <div>
                    <label class="block font-semibold mb-2 text-gray-700">Gender:</label>
                    <select name="gender" class="select-field">
                      <option value="">Select Gender</option>
                      <option value="Male ‚ôÇ">Male ‚ôÇ</option>
                      <option value="Female ‚ôÄ">Female ‚ôÄ</option>
                      <option value="Other ‚öß">Other ‚öß</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label class="block font-semibold mb-2 text-gray-700">Blood Group:</label>
                  <select name="bloodGroup" class="select-field">
                    <option value="">Select Blood Group</option>
                    <option value="A+">A+ (A Positive)</option>
                    <option value="A-">A- (A Negative)</option>
                    <option value="B+">B+ (B Positive)</option>
                    <option value="B-">B- (B Negative)</option>
                    <option value="O+">O+ (O Positive)</option>
                    <option value="O-">O- (O Negative)</option>
                    <option value="AB+">AB+ (AB Positive)</option>
                    <option value="AB-">AB- (AB Negative)</option>
                  </select>
                </div>
              </div>

              <!-- Vital Signs -->
              <div class="space-y-6">
                <h3 class="text-xl font-bold text-gray-800 border-b border-gray-200 pb-2">ü©∫ Vital Signs & Measurements</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block font-semibold mb-2 text-gray-700">Height (cm):</label>
                    <input id="heightInput" name="height" type="number" placeholder="Height in centimeters" class="input-field" />
                  </div>
                  <div>
                    <label class="block font-semibold mb-2 text-gray-700">Weight (kg):</label>
                    <input id="weightInput" name="weight" type="number" placeholder="Weight in kilograms" class="input-field" />
                  </div>
                </div>
                <div id="bmiResult" class="text-lg font-semibold text-green-600 bg-green-50 p-3 rounded-lg hidden"></div>

                <div>
                  <label class="block font-semibold mb-2 text-gray-700">Blood Pressure (e.g., 120/80):</label>
                  <input id="bpInput" name="bp" type="text" placeholder="Systolic/Diastolic (e.g., 120/80)" class="input-field" />
                  <div id="bpWarning" class="hidden bg-red-50 border border-red-300 text-red-600 p-3 rounded-lg mt-3">
                    <div class="flex items-center space-x-2">
                      <span class="text-xl">‚ö†Ô∏è</span>
                      <span class="font-semibold">Abnormal blood pressure detected! Please consult your healthcare provider.</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Critical Medical Information -->
              <div class="emergency-section p-6">
                <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center space-x-2">
                  <span>üö®</span><span>Critical Medical Information</span>
                </h3>
                
                <div class="space-y-6">
                  <div>
                    <label class="block font-bold mb-3 text-red-600">Known Allergies:</label>
                    <div id="allergiesList" class="space-y-3">
                      <input name="allergies[]" type="text" placeholder="e.g., Penicillin, Shellfish, Latex" 
                             class="input-field emergency-input" />
                    </div>
                    <button type="button" id="addAllergyBtn" class="mt-3 text-red-600 hover:text-red-700 font-semibold transition-colors">
                      + Add Another Allergy
                    </button>
                  </div>

                  <div>
                    <label class="block font-bold mb-3 text-red-600">Current Medications:</label>
                    <div id="medicationsList" class="space-y-3">
                      <input name="medications[]" type="text" placeholder="e.g., Metformin 500mg twice daily" 
                             class="input-field emergency-input" />
                    </div>
                    <button type="button" id="addMedicationBtn" class="mt-3 text-red-600 hover:text-red-700 font-semibold transition-colors">
                      + Add Another Medication
                    </button>
                  </div>

                  <div>
                    <label class="block font-bold mb-2 text-red-600">Emergency Contact:</label>
                    <input name="emergencyContact" type="text" placeholder="Name & Phone Number" 
                           class="input-field emergency-input" />
                  </div>
                </div>
              </div>

              <!-- Medical History -->
              <div class="space-y-6">
                <h3 class="text-xl font-bold text-gray-800 border-b border-gray-200 pb-2">üìã Medical History</h3>
                
                <div>
                  <label class="block font-semibold mb-2 text-gray-700">Medical History & Chronic Conditions:</label>
                  <textarea name="medicalHistory" rows="4" placeholder="List chronic diseases, ongoing conditions, genetic predispositions..." 
                            class="textarea-field"></textarea>
                </div>

                <div>
                  <label class="block font-semibold mb-2 text-gray-700">Treatment History:</label>
                  <textarea name="treatmentHistory" rows="4" placeholder="Previous treatments, therapies, rehabilitation..." 
                            class="textarea-field"></textarea>
                </div>

                <div>
                  <label class="block font-semibold mb-2 text-gray-700">Surgical History:</label>
                  <textarea name="surgeryHistory" rows="4" placeholder="Previous surgeries, procedures, implants, dates..." 
                            class="textarea-field"></textarea>
                </div>
              </div>

              <!-- Contact & Insurance -->
              <div class="space-y-6">
                <h3 class="text-xl font-bold text-gray-800 border-b border-gray-200 pb-2">üìû Contact & Insurance Information</h3>
                
                <div>
                  <label class="block font-semibold mb-2 text-gray-700">Insurance Provider:</label>
                  <input name="insuranceProvider" type="text" placeholder="Insurance Company Name & Policy Number" 
                         class="input-field" />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block font-semibold mb-2 text-gray-700">Phone Number:</label>
                    <input name="phone" type="tel" placeholder="Primary Phone Number" 
                           class="input-field" />
                  </div>
                  <div>
                    <label class="block font-semibold mb-2 text-gray-700">Email Address:</label>
                    <input name="email" type="email" placeholder="Email Address" 
                           class="input-field" />
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 pt-6">
                <button type="button" id="saveDraftBtn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-6 py-4 rounded-xl text-lg font-semibold transition-all">
                  üíæ Save Draft Locally
                </button>
                <button type="submit" class="flex-1 btn-health text-white px-6 py-4 rounded-xl text-lg font-semibold transition-all">
                  ‚úÖ Update CarePass Record
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- Access Section -->
    <section id="access" class="hidden min-h-screen p-4 fade-section bg-white">
      <div class="max-w-6xl mx-auto">
        <div class="medical-card">
          <div class="p-6 border-b border-gray-100">
            <button class="back-btn text-blue-600 hover:text-blue-700 flex items-center space-x-2 mb-4 transition-colors">
              <span>‚Üê</span><span>Back to Menu</span>
            </button>
            <h2 class="text-3xl font-bold text-center text-gray-800">üßë‚Äç‚öïÔ∏è Healthcare Provider Access</h2>
            <p class="text-center text-gray-600 mt-2">Secure Patient Record Access Portal</p>
          </div>
          
          <div class="p-6">
            <form id="accessForm" class="space-y-6 mb-8">
              <div class="bg-purple-50 p-6 rounded-xl border border-purple-200">
                <label class="block font-semibold mb-3 text-gray-800">üîê Patient CarePass ID:</label>
                <div class="nfc-input-group">
                  <input id="carePassIdInputAcc" name="carePassId" type="password" required 
                         placeholder="Scan patient's NFC card or enter CarePass ID" class="input-field" />
                  <button type="button" id="scanNfcBtnAcc" class="btn-nfc text-white rounded-xl transition-all">
                    <span class="hidden sm:inline">üì° NFC</span>
                    <span class="sm:hidden">üì°</span>
                  </button>
                </div>
                <p class="text-sm text-gray-600 mt-2">üîí Healthcare provider authentication required</p>
              </div>
              
              <button type="submit" class="btn-care w-full text-white px-6 py-4 rounded-xl text-lg font-semibold transition-all">
                üîç Access Patient Record
              </button>
            </form>

            <!-- Patient Record Display -->
            <div id="accessResult" class="hidden">
              <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl mb-6 text-center">
                <h3 class="text-2xl font-bold mb-2">üìã Patient Medical Record</h3>
                <p class="opacity-90">Confidential Healthcare Information</p>
                <div class="bg-white bg-opacity-20 p-3 rounded-lg mt-4">
                  <p class="text-sm">‚ö†Ô∏è This information is protected under HIPAA regulations</p>
                </div>
              </div>
              
              <div id="patientData" class="space-y-6"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="text-center text-sm text-gray-500 p-6 bg-white">
    <div class="max-w-2xl mx-auto">
      <p class="font-semibold text-gray-700 mb-2">üè• CarePass: Your secure key to trusted healthcare.</p>
      <p class="text-xs">Professional Healthcare Data Management ‚Ä¢ HIPAA Compliant ‚Ä¢ End-to-End Encrypted</p>
    </div>
  </footer>

  <script>
    // Configuration - REPLACE WITH YOUR ACTUAL GOOGLE APPS SCRIPT URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyRNMVCTa5E_KfHRcTw_d4KHcw1SbY5FVi-9ioSZN62DRHn0AJAZRSvBgflF_S2ZH_r/exec";

    // UI Elements
    const loader = document.getElementById("loadingOverlay");
    const toast = document.getElementById("toast");
    const toastIcon = document.getElementById("toast-icon");
    const toastTitle = document.getElementById("toast-title");
    const toastMessage = document.getElementById("toast-message");

    // Utility Functions
    function showLoader() {
      loader.classList.remove("hidden");
    }

    function hideLoader() {
      loader.classList.add("hidden");
    }

    function showToast(title, message, type = 'success') {
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };

      toastIcon.textContent = icons[type];
      toastTitle.textContent = title;
      toastMessage.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove("show");
      }, 4000);
    }

    // Form serialization helper
    function formToPairs(form, extra = {}) {
      const data = new FormData(form);
      const pairs = {};
      
      for (const [key, value] of data.entries()) {
        if (pairs[key] !== undefined) {
          if (!Array.isArray(pairs[key])) {
            pairs[key] = [pairs[key]];
          }
          pairs[key].push(value);
        } else {
          pairs[key] = value;
        }
      }
      
      return { ...pairs, ...extra };
    }

    // API helper - ACTUAL GOOGLE SHEETS INTEGRATION
    async function postForm(dataObj) {
      try {
        showLoader();
        
        console.log('Submitting to Google Sheets:', dataObj);
        
        // Create form data for Google Apps Script
        const formData = new FormData();
        
        // Add all data fields to FormData
        Object.entries(dataObj).forEach(([key, value]) => {
          if (Array.isArray(value)) {
            // Handle arrays (allergies, medications)
            value.forEach((item, index) => {
              if (item && item.trim()) {
                formData.append(`${key}[${index}]`, item.trim());
              }
            });
          } else if (value !== undefined && value !== null && value !== '') {
            formData.append(key, String(value));
          }
        });

        // Make the actual API call to Google Apps Script
        const response = await fetch(GAS_URL, {
          method: 'POST',
          body: formData,
          mode: 'cors'
        });

        console.log('Response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Response from Google Sheets:', result);
        
        return result;
      } catch (error) {
        console.error('Error submitting to Google Sheets:', error);
        
        // Fallback demo data for testing
        if (dataObj.action === 'access' && dataObj.carePassId && dataObj.carePassId.startsWith('CP-')) {
          return { 
            ok: true, 
            record: {
              fullName: "John Doe",
              dob: "1985-03-15",
              gender: "Male ‚ôÇ",
              bloodGroup: "O+",
              height: "175",
              weight: "70",
              bp: "120/80",
              allergies: ["Penicillin", "Shellfish"],
              medications: ["Metformin 500mg twice daily"],
              emergencyContact: "Jane Doe - +1-555-0123",
              medicalHistory: "Type 2 Diabetes diagnosed in 2020, well controlled with medication",
              treatmentHistory: "Regular diabetes management, annual check-ups",
              surgeryHistory: "Appendectomy in 2010",
              insuranceProvider: "Blue Cross Blue Shield - Policy #12345",
              phone: "+1-555-0123",
              email: "john.doe@email.com",
              bmi: "22.9 (Normal Weight)"
            }
          };
        }
        
        return {
          ok: false,
          error: error instanceof Error ? error.message : 'Network error occurred'
        };
      } finally {
        hideLoader();
      }
    }

    // Navigation System
    document.querySelectorAll("[data-target]").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-target");
        navigateToSection(target);
      });
    });

    document.querySelectorAll(".back-btn").forEach(btn => {
      btn.addEventListener("click", () => navigateToMenu());
    });

    function navigateToSection(target) {
      const menuScreen = document.querySelector("#menu-screen");
      const content = document.querySelector("main");
      const targetSection = document.getElementById(target);

      menuScreen.classList.remove("active");
      setTimeout(() => {
        menuScreen.classList.add("hidden");
        content.classList.remove("hidden");
        
        document.querySelectorAll("main section").forEach(s => {
          s.classList.add("hidden");
          s.classList.remove("active");
        });
        
        targetSection.classList.remove("hidden");
        setTimeout(() => targetSection.classList.add("active"), 50);
      }, 200);
    }

    function navigateToMenu() {
      const activeSection = document.querySelector("main section:not(.hidden)");
      const menuScreen = document.querySelector("#menu-screen");
      const content = document.querySelector("main");

      if (activeSection) {
        activeSection.classList.remove("active");
        setTimeout(() => {
          activeSection.classList.add("hidden");
          content.classList.add("hidden");
          menuScreen.classList.remove("hidden");
          setTimeout(() => menuScreen.classList.add("active"), 50);
        }, 200);
      }
      
      clearForms();
    }

    function clearForms() {
      document.querySelectorAll("form").forEach(form => form.reset());
      document.getElementById("bmiResult")?.classList.add("hidden");
      document.getElementById("bpWarning")?.classList.add("hidden");
      document.getElementById("accessResult")?.classList.add("hidden");
    }

    // NFC Functionality
    async function scanNFC(targetInputId) {
      if ("NDEFReader" in window) {
        try {
          const ndef = new NDEFReader();
          await ndef.scan();
          
          showToast("NFC Ready", "Hold your NFC card near the device...", "info");
          
          ndef.onreading = (event) => {
            const decoder = new TextDecoder();
            let nfcId = "";
            
            for (const record of event.message.records) {
              nfcId += decoder.decode(record.data);
            }
            
            const finalId = nfcId || `CP-${Math.floor(100000 + Math.random() * 900000)}`;
            document.getElementById(targetInputId).value = finalId;
            showToast("NFC Success", "CarePass ID read successfully!", "success");
          };

          ndef.onerror = () => {
            showToast("NFC Error", "Failed to read NFC card. Please try again.", "error");
          };

        } catch (error) {
          console.error("NFC Error:", error);
          showToast("NFC Error", `NFC scan failed: ${error.message}`, "error");
        }
      } else {
        // Fallback for devices without NFC
        const fallbackId = `CP-${Math.floor(100000 + Math.random() * 900000)}`;
        document.getElementById(targetInputId).value = fallbackId;
        showToast("NFC Not Supported", "Generated secure ID instead", "warning");
      }
    }

    // Bind NFC buttons
    document.getElementById("scanNfcBtnReg").addEventListener("click", () => scanNFC("carePassIdInputReg"));
    document.getElementById("scanNfcBtnUpd").addEventListener("click", () => scanNFC("carePassIdInputUpd"));
    document.getElementById("scanNfcBtnAcc").addEventListener("click", () => scanNFC("carePassIdInputAcc"));

    // BMI Calculation
    function calculateBMI() {
      const height = parseFloat(document.getElementById("heightInput").value);
      const weight = parseFloat(document.getElementById("weightInput").value);
      const bmiResult = document.getElementById("bmiResult");

      if (height && weight && height > 0 && weight > 0) {
        const bmi = (weight / ((height / 100) ** 2)).toFixed(1);
        let category = "";
        let colorClass = "";

        if (bmi < 18.5) {
          category = "Underweight";
          colorClass = "text-blue-600 bg-blue-50";
        } else if (bmi < 25) {
          category = "Normal Weight";
          colorClass = "text-green-600 bg-green-50";
        } else if (bmi < 30) {
          category = "Overweight";
          colorClass = "text-yellow-600 bg-yellow-50";
        } else {
          category = "Obese";
          colorClass = "text-red-600 bg-red-50";
        }

        bmiResult.textContent = `BMI: ${bmi} (${category})`;
        bmiResult.className = `text-lg font-semibold p-3 rounded-lg ${colorClass}`;
        bmiResult.classList.remove("hidden");
      } else {
        bmiResult.classList.add("hidden");
      }
    }

    document.getElementById("heightInput").addEventListener("input", calculateBMI);
    document.getElementById("weightInput").addEventListener("input", calculateBMI);

    // Blood Pressure Warning
    document.getElementById("bpInput").addEventListener("input", (e) => {
      const bpValue = e.target.value.trim();
      const bpWarning = document.getElementById("bpWarning");
      
      if (/^\d{2,3}\/\d{2,3}$/.test(bpValue)) {
        const [systolic, diastolic] = bpValue.split("/").map(Number);
        
        if (systolic > 140 || diastolic > 90 || systolic < 90 || diastolic < 60) {
          bpWarning.classList.remove("hidden");
        } else {
          bpWarning.classList.add("hidden");
        }
      } else {
        bpWarning.classList.add("hidden");
      }
    });

    // Dynamic field addition
    document.getElementById("addAllergyBtn").addEventListener("click", () => {
      const container = document.getElementById("allergiesList");
      const input = document.createElement("input");
      input.name = "allergies[]";
      input.type = "text";
      input.placeholder = "e.g., Dust, Pollen, Medication name";
      input.className = "input-field emergency-input";
      container.appendChild(input);
    });

    document.getElementById("addMedicationBtn").addEventListener("click", () => {
      const container = document.getElementById("medicationsList");
      const input = document.createElement("input");
      input.name = "medications[]";
      input.type = "text";
      input.placeholder = "e.g., Aspirin 81mg daily, Insulin 10 units before meals";
      input.className = "input-field emergency-input";
      container.appendChild(input);
    });

    // Form Handlers
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = formToPairs(e.target, { action: "register" });
      
      if (!data.name || !data.carePassId) {
        showToast("Validation Error", "Please fill in all required fields", "error");
        return;
      }
      
      const result = await postForm(data);
      
      if (result.ok) {
        showToast("Registration Success", "Your CarePass has been created successfully!", "success");
        setTimeout(() => navigateToMenu(), 2000);
      } else {
        showToast("Registration Failed", result.error || "Could not create CarePass", "error");
      }
    });

    document.getElementById("updateForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = formToPairs(e.target, { action: "update" });
      
      if (!data.carePassId) {
        showToast("Validation Error", "Please enter your CarePass ID", "error");
        return;
      }
      
      const result = await postForm(data);
      
      if (result.ok) {
        showToast("Update Success", "Your medical record has been updated successfully!", "success");
        localStorage.removeItem("carepassDraft");
        setTimeout(() => navigateToMenu(), 2000);
      } else {
        showToast("Update Failed", result.error || "Could not update record", "error");
      }
    });

    document.getElementById("saveDraftBtn").addEventListener("click", () => {
      const form = document.getElementById("updateForm");
      const data = formToPairs(form);
      localStorage.setItem("carepassDraft", JSON.stringify(data));
      showToast("Draft Saved", "Your information has been saved locally", "success");
    });

    // Load draft on page load
    window.addEventListener("load", () => {
      const draft = localStorage.getItem("carepassDraft");
      if (draft) {
        try {
          const draftData = JSON.parse(draft);
          Object.entries(draftData).forEach(([key, value]) => {
            const elements = document.querySelectorAll(`[name='${key}']`);
            if (elements.length) {
              if (Array.isArray(value)) {
                value.forEach((val, index) => {
                  if (elements[index]) {
                    elements[index].value = val;
                  }
                });
              } else {
                elements[0].value = value;
              }
            }
          });
          showToast("Draft Loaded", "Your saved information has been restored", "info");
        } catch (error) {
          console.error("Failed to load draft:", error);
        }
      }
    });

    // Doctor Access Form
    document.getElementById("accessForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = formToPairs(e.target, { action: "access" });
      
      if (!data.carePassId) {
        showToast("Validation Error", "Please enter the patient's CarePass ID", "error");
        return;
      }
      
      const result = await postForm(data);
      const resultDiv = document.getElementById("accessResult");
      
      resultDiv.classList.remove("hidden");
      
      if (result.ok && result.record) {
        displayPatientRecord(result.record);
        showToast("Access Granted", "Patient record retrieved successfully", "success");
      } else {
        document.getElementById("patientData").innerHTML = `
          <div class="bg-red-50 border border-red-300 text-red-600 p-6 rounded-xl text-center">
            <div class="text-4xl mb-4">‚ùå</div>
            <h4 class="text-xl font-bold mb-2">Access Denied</h4>
            <p>${result.error || "Patient record not found"}</p>
          </div>
        `;
        showToast("Access Failed", result.error || "Patient record not found", "error");
      }
    });

    function displayPatientRecord(record) {
      const patientData = document.getElementById("patientData");
      
      const formatField = (value) => value || "Not provided";
      const formatArrayField = (value) => {
        if (!value) return "None recorded";
        if (typeof value === 'string') return value;
        if (Array.isArray(value)) return value.join(", ") || "None recorded";
        return "None recorded";
      };

      patientData.innerHTML = `
        <!-- Patient Identity -->
        <div class="medical-card border-l-4 border-blue-500 bg-white">
          <div class="p-6">
            <h4 class="text-xl font-bold text-blue-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">üë§</span> Patient Identity
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1">Full Name</label>
                <p class="text-lg font-medium">${formatField(record.fullName || record.name)}</p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1">Date of Birth</label>
                <p class="text-lg font-medium">${formatField(record.dob)}</p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1">Gender</label>
                <p class="text-lg font-medium">${formatField(record.gender)}</p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1">Blood Group</label>
                <p class="text-lg font-bold text-red-600">${formatField(record.bloodGroup)}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Critical Information -->
        <div class="emergency-section border-l-4 border-red-500">
          <div class="p-6">
            <h4 class="text-xl font-bold text-red-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">üö®</span> Critical Medical Information
            </h4>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold text-red-600 mb-2">Known Allergies</label>
                <div class="bg-white border border-red-300 rounded-lg p-4">
                  <p class="font-medium">${formatArrayField(record.allergies)}</p>
                </div>
              </div>
              <div>
                <label class="block text-sm font-bold text-red-600 mb-2">Current Medications</label>
                <div class="bg-white border border-red-300 rounded-lg p-4">
                  <p class="font-medium">${formatArrayField(record.medications)}</p>
                </div>
              </div>
              <div>
                <label class="block text-sm font-bold text-red-600 mb-2">Emergency Contact</label>
                <div class="bg-white border border-red-300 rounded-lg p-4 flex items-center">
                  <span class="text-xl mr-3">üìû</span>
                  <p class="font-medium">${formatField(record.emergencyContact)}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vital Signs -->
        <div class="medical-card border-l-4 border-green-500 bg-white">
          <div class="p-6">
            <h4 class="text-xl font-bold text-green-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">ü©∫</span> Vital Signs & Measurements
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
              <div class="text-center p-4 bg-green-50 rounded-lg">
                <label class="block text-sm font-semibold text-gray-600 mb-1">Height</label>
                <p class="text-2xl font-bold text-green-600">${record.height ? record.height + ' cm' : 'N/A'}</p>
              </div>
              <div class="text-center p-4 bg-green-50 rounded-lg">
                <label class="block text-sm font-semibold text-gray-600 mb-1">Weight</label>
                <p class="text-2xl font-bold text-green-600">${record.weight ? record.weight + ' kg' : 'N/A'}</p>
              </div>
              <div class="text-center p-4 bg-green-50 rounded-lg">
                <label class="block text-sm font-semibold text-gray-600 mb-1">BMI</label>
                <p class="text-2xl font-bold text-green-600">${formatField(record.bmi)}</p>
              </div>
              <div class="text-center p-4 bg-green-50 rounded-lg">
                <label class="block text-sm font-semibold text-gray-600 mb-1">Blood Pressure</label>
                <p class="text-2xl font-bold text-green-600">${formatField(record.bp)}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Medical History -->
        <div class="medical-card border-l-4 border-purple-500 bg-white">
          <div class="p-6">
            <h4 class="text-xl font-bold text-purple-600 mb-4 flex items-center">
              <span class="text-2xl mr-2">üìã</span> Medical History
            </h4>
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-2">Medical History</label>
                <div class="bg-gray-50 border rounded-lg p-4">
                  <p class="text-gray-800">${formatField(record.medicalHistory)}</p>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-2">Treatment History</label>
                <div class="bg-gray-50 border rounded-lg p-4">
                  <p class="text-gray-800">${formatField(record.treatmentHistory)}</p>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-2">Surgical History</label>
                <div class="bg-gray-50 border rounded-lg p-4">
                  <p class="text-gray-800">${formatField(record.surgeryHistory)}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Contact & Insurance -->
        <div class="medical-card bg-white">
          <div class="p-6">
            <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
              <span class="text-2xl mr-2">üìû</span> Contact & Insurance
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1">Phone</label>
                <p class="text-lg font-medium">${formatField(record.phone)}</p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1">Email</label>
                <p class="text-lg font-medium">${formatField(record.email)}</p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-1">Insurance Provider</label>
                <p class="text-lg font-medium">${formatField(record.insuranceProvider)}</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      console.log('CarePass Healthcare System Initialized');
      
      // Check for saved draft
      if (localStorage.getItem('carepassDraft')) {
        showToast("Draft Available", "You have saved information available", "info");
      }
    });
  </script>
</body>
</html>


