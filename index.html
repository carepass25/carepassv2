<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>CarePass – Your Key to Secure Health Data</title>
  <link rel="icon" href="assets/IMG_20250822_103325.png" type="image/png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* transitions */
    .fade-section { opacity: 0; transform: scale(0.95); transition: all 0.4s ease-in-out; }
    .fade-section.active { opacity: 1; transform: scale(1); }
    @media (min-width:1024px) { .fade-section { transform: scale(0.92); } .fade-section.active { transform: scale(1.03); } }
    input, select, textarea, button { font-size: 16px; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

  <!-- Loader -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col items-center space-y-3">
      <div class="w-12 h-12 border-4 border-dashed border-blue-600 rounded-full animate-spin"></div>
      <p class="text-gray-700 font-medium">Processing...</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow z-50 text-white"></div>

  <!-- Menu -->
  <div id="menu-screen" class="max-w-lg mx-auto p-6 space-y-6 fade-section active">
    <h2 class="text-3xl font-bold text-center mb-4">💙 CarePass 🩺</h2>
    <div class="grid gap-4">
      <button data-target="register" class="w-full bg-blue-600 text-white p-5 rounded-xl shadow hover:bg-blue-700 text-lg">🔐 Create CarePass</button>
      <button data-target="update" class="w-full bg-green-600 text-white p-5 rounded-xl shadow hover:bg-green-700 text-lg">📝 Update Records</button>
      <button data-target="access" class="w-full bg-indigo-600 text-white p-5 rounded-xl shadow hover:bg-indigo-700 text-lg">🧑‍⚕ Doctor Access</button>
    </div>
  </div>

  <!-- Main content -->
  <main id="content" class="max-w-lg mx-auto p-4 sm:p-6 space-y-10 hidden">

    <!-- Register -->
    <section id="register" class="hidden bg-white p-6 rounded-lg shadow fade-section">
      <button class="back-btn text-sm text-blue-600 underline mb-4">← Back to Menu</button>
      <h2 class="text-2xl font-semibold mb-4">🔐 Create Your CarePass</h2>
      <form id="registerForm" class="space-y-4">
        <div>
          <label class="block font-medium mb-1">Role:</label>
          <select name="role" required class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-blue-400">
            <option value="patient">Patient</option>
            <option value="doctor">Doctor</option>
          </select>
        </div>
        <div>
          <label class="block font-medium mb-1">Name:</label>
          <input name="name" type="text" required placeholder="Enter your name" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
          <label class="block font-medium mb-1">CarePass ID (via NFC):</label>
          <div class="flex space-x-2">
            <input id="carePassIdInputReg" name="carePassId" type="password" required placeholder="Tap NFC card" class="flex-1 border border-gray-300 p-3 rounded focus:ring-2 focus:ring-blue-400" />
            <button type="button" id="scanNfcBtnReg" class="bg-indigo-600 text-white px-4 rounded hover:bg-indigo-700">📡 Scan NFC</button>
          </div>
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded text-base">Create CarePass</button>
      </form>
    </section>

    <!-- Update -->
    <section id="update" class="hidden bg-white p-6 rounded-lg shadow fade-section">
      <button class="back-btn text-sm text-blue-600 underline mb-4">← Back to Menu</button>
      <h2 class="text-2xl font-semibold mb-4">📝 Update Your CarePass Record</h2>
      <form id="updateForm" class="space-y-6">
        <div class="flex space-x-2">
          <input id="carePassIdInputUpd" name="carePassId" type="password" required placeholder="Tap NFC card" class="flex-1 border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400" />
          <button type="button" id="scanNfcBtnUpd" class="bg-indigo-600 text-white px-4 rounded hover:bg-indigo-700">📡 Scan NFC</button>
        </div>

        <div>
          <label class="block font-medium mb-1">Full Name:</label>
          <input name="fullName" type="text" placeholder="Full Name" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400" />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1">Date of Birth:</label>
            <input name="dob" type="date" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400" />
          </div>
          <div>
            <label class="block font-medium mb-1">Gender:</label>
            <select name="gender" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400">
              <option value="">Select Gender</option>
              <option>Male ♂</option>
              <option>Female ♀</option>
              <option>Other ⚧</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block font-medium mb-1">Blood Group:</label>
          <select name="bloodGroup" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400">
            <option value="">Blood Group</option>
            <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
            <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1">Height (cm):</label>
            <input id="heightInput" name="height" type="number" placeholder="Height (cm)" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400" />
          </div>
          <div>
            <label class="block font-medium mb-1">Weight (kg):</label>
            <input id="weightInput" name="weight" type="number" placeholder="Weight (kg)" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400" />
          </div>
        </div>
        <p id="bmiResult" class="text-sm text-gray-600"></p>

        <div>
          <label class="block font-medium mb-1">Blood Pressure (e.g. 120/80):</label>
          <input id="bpInput" name="bp" type="text" placeholder="Blood Pressure e.g. 120/80" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400" />
          <p id="bpWarning" class="text-sm text-red-600 hidden">⚠ Abnormal BP detected!</p>
        </div>

        <div class="p-3 border border-red-300 rounded bg-red-50">
          <label class="block font-semibold text-red-600 mb-1">Known Allergies:</label>
          <div id="allergiesList" class="space-y-2">
            <input name="allergies[]" type="text" placeholder="e.g. Penicillin" class="w-full border border-gray-300 p-2 rounded" />
          </div>
          <button type="button" id="addAllergyBtn" class="mt-2 text-sm text-red-600 underline">+ Add More</button>
        </div>

        <div class="p-3 border border-red-300 rounded bg-red-50">
          <label class="block font-semibold text-red-600 mb-1">Current Medications:</label>
          <div id="medicationsList" class="space-y-2">
            <input name="medications[]" type="text" placeholder="e.g. Metformin 500mg daily" class="w-full border border-gray-300 p-2 rounded" />
          </div>
          <button type="button" id="addMedicationBtn" class="mt-2 text-sm text-red-600 underline">+ Add More</button>
        </div>

        <div>
          <label class="block font-medium mb-1">Emergency Contact:</label>
          <input name="emergencyContact" type="text" placeholder="Name & Phone" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-red-400" />
        </div>

        <div>
          <label class="block font-medium mb-1">Medical History:</label>
          <textarea name="medicalHistory" placeholder="Chronic diseases, conditions..." class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400"></textarea>
        </div>

        <div>
          <label class="block font-medium mb-1">Treatment History:</label>
          <textarea name="treatmentHistory" placeholder="Therapies, medications used..." class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400"></textarea>
        </div>

        <div>
          <label class="block font-medium mb-1">Previous Surgeries:</label>
          <textarea name="surgeryHistory" placeholder="Surgical history, implants..." class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400"></textarea>
        </div>

        <div>
          <label class="block font-medium mb-1">Insurance Provider:</label>
          <input name="insuranceProvider" type="text" placeholder="Insurance Provider" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400" />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1">Phone:</label>
            <input name="phone" type="tel" placeholder="Phone" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400" />
          </div>
          <div>
            <label class="block font-medium mb-1">Email:</label>
            <input name="email" type="email" placeholder="Email" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-green-400" />
          </div>
        </div>

        <div class="flex justify-between space-x-2">
          <button type="button" id="saveDraftBtn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-4 py-3 rounded text-base">💾 Save Draft</button>
          <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded text-base">✅ Save to CarePass</button>
        </div>
      </form>
    </section>

    <!-- Access -->
    <section id="access" class="hidden bg-white p-6 rounded-lg shadow fade-section">
      <button class="back-btn text-sm text-blue-600 underline mb-4">← Back to Menu</button>
      <h2 class="text-2xl font-semibold mb-4">🧑‍⚕ Doctor Access</h2>
      <form id="accessForm" class="space-y-4">
        <div class="flex space-x-2">
          <input id="carePassIdInputAcc" name="carePassId" type="password" required placeholder="Tap NFC card" class="flex-1 border border-gray-300 p-3 rounded focus:ring-2 focus:ring-indigo-400" />
          <button type="button" id="scanNfcBtnAcc" class="bg-indigo-600 text-white px-4 rounded hover:bg-indigo-700">📡 Scan NFC</button>
        </div>
        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded text-base">Access Record</button>
      </form>
      <div id="accessResult" class="mt-6 hidden bg-gray-100 p-4 rounded-lg text-sm"></div>
    </section>

  </main>

  <footer class="text-center text-sm text-gray-500 p-4">CarePass: Your secure key to trusted healthcare.</footer>

  <script>
  // Backend endpoint
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxJ6ufD8wXV338ZGXHqNIDhHe2CWV5PaRJ3ot2cmzvYuAM8zRkhSr56nWO2kP2Y05uN/exec";

  const loader = document.getElementById("loadingOverlay");
  const toast = document.getElementById("toast");

  function showLoader() { loader.classList.remove("hidden"); }
  function hideLoader() { loader.classList.add("hidden"); }

  function showToast(msg, success = true) {
    toast.textContent = msg;
    toast.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow z-50 ${success ? "bg-green-600" : "bg-red-600"} text-white`;
    toast.classList.remove("hidden");
    setTimeout(() => toast.classList.add("hidden"), 2500);
  }

  // Serialize form
  function formToPairs(form, extra = {}) {
    const data = new FormData(form);
    const pairs = {};
    for (const [key, value] of data.entries()) {
      if (pairs[key] !== undefined) {
        if (!Array.isArray(pairs[key])) pairs[key] = [pairs[key]];
        pairs[key].push(value);
      } else {
        pairs[key] = value;
      }
    }
    return { ...pairs, ...extra };
  }

  // POST helper
  async function postForm(dataObj) {
    try {
      showLoader();
      const body = new URLSearchParams();
      for (const [k, v] of Object.entries(dataObj)) {
        if (Array.isArray(v)) v.forEach(x => body.append(k, x));
        else body.append(k, v);
      }
      const res = await fetch(GAS_URL, { method: "POST", body });
      return await res.json();
    } catch (err) {
      console.error("Fetch error:", err);
      return { ok: false, error: "Network error" };
    } finally {
      hideLoader();
    }
  }

  // Navigation
  document.querySelectorAll("[data-target]").forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-target");
      document.querySelector("#menu-screen").classList.remove("active");
      setTimeout(() => {
        document.querySelector("#menu-screen").classList.add("hidden");
        document.querySelector("main").classList.remove("hidden");
        document.querySelectorAll("main section").forEach(s => s.classList.add("hidden"));
        const section = document.getElementById(target);
        section.classList.remove("hidden");
        setTimeout(() => section.classList.add("active"), 20);
      }, 220);
    });
  });

  // Back to menu
  document.querySelectorAll(".back-btn").forEach(btn => {
    btn.addEventListener("click", () => goHome());
  });
  function goHome() {
    const activeSection = document.querySelector("main section:not(.hidden)");
    if (activeSection) {
      activeSection.classList.remove("active");
      setTimeout(() => {
        activeSection.classList.add("hidden");
        document.querySelector("main").classList.add("hidden");
        document.querySelector("#menu-screen").classList.remove("hidden");
        setTimeout(() => document.querySelector("#menu-screen").classList.add("active"), 20);
      }, 220);
    }
    clearForms();
  }

  function clearForms() {
    document.querySelectorAll("form").forEach(f => f.reset());
    if (document.getElementById("bmiResult")) document.getElementById("bmiResult").textContent = "";
    if (document.getElementById("bpWarning")) document.getElementById("bpWarning").classList.add("hidden");
  }

  // ✅ Web NFC support
  async function scanNfc(targetInputId) {
    if ("NDEFReader" in window) {
      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        showToast("📡 Hold your NFC card near the phone...");
        ndef.onreading = event => {
          const decoder = new TextDecoder();
          let nfcId = "";
          for (const record of event.message.records) {
            nfcId += decoder.decode(record.data);
          }
          document.getElementById(targetInputId).value =
            nfcId || "CP-" + Math.floor(100000 + Math.random() * 900000);
          showToast("✅ NFC Card read successfully");
        };
      } catch (error) {
        console.error("NFC Scan failed:", error);
        showToast("❌ NFC scan error: " + error.message, false);
      }
    } else {
      showToast("⚠️ Web NFC not supported on this device", false);
    }
  }

  // Bind NFC buttons
  document.getElementById("scanNfcBtnReg").addEventListener("click", () => scanNfc("carePassIdInputReg"));
  document.getElementById("scanNfcBtnUpd").addEventListener("click", () => scanNfc("carePassIdInputUpd"));
  document.getElementById("scanNfcBtnAcc").addEventListener("click", () => scanNfc("carePassIdInputAcc"));

  // BMI calculation
  ["heightInput","weightInput"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("input", () => {
      const h = parseFloat(document.getElementById("heightInput").value);
      const w = parseFloat(document.getElementById("weightInput").value);
      if (h && w) {
        const bmi = (w / ((h/100) ** 2)).toFixed(1);
        let status = bmi < 18.5 ? "Underweight" : bmi < 25 ? "Normal" : bmi < 30 ? "Overweight" : "Obese";
        document.getElementById("bmiResult").textContent = `BMI: ${bmi} (${status})`;
      }
    });
  });

  // BP warning
  document.getElementById("bpInput").addEventListener("input", e => {
    const txt = e.target.value.trim();
    const warn = document.getElementById("bpWarning");
    if (/^\d{2,3}\/\d{2,3}$/.test(txt)) {
      const [s, d] = txt.split("/").map(Number);
      warn.classList.toggle("hidden", !(s > 140 || d > 90));
    } else {
      warn.classList.add("hidden");
    }
  });

  // Add allergy/medication fields
  document.getElementById("addAllergyBtn").addEventListener("click", () => {
    const div = document.createElement("div");
    div.innerHTML = `<input name="allergies[]" type="text" placeholder="e.g. Dust" class="w-full border border-gray-300 p-2 rounded" />`;
    document.getElementById("allergiesList").appendChild(div);
  });
  document.getElementById("addMedicationBtn").addEventListener("click", () => {
    const div = document.createElement("div");
    div.innerHTML = `<input name="medications[]" type="text" placeholder="e.g. Paracetamol 500mg" class="w-full border border-gray-300 p-2 rounded" />`;
    document.getElementById("medicationsList").appendChild(div);
  });

  // Register
  document.getElementById("registerForm").addEventListener("submit", async e => {
    e.preventDefault();
    const data = formToPairs(e.target, { action: "register" });
    const res = await postForm(data);
    showToast(res.ok ? "✅ CarePass created" : "❌ Error: " + res.error, res.ok);
    if (res.ok) goHome();
  });

  // Update
  document.getElementById("updateForm").addEventListener("submit", async e => {
    e.preventDefault();
    const data = formToPairs(e.target, { action: "update" });
    const res = await postForm(data);
    showToast(res.ok ? "✅ Record updated" : "❌ Error: " + res.error, res.ok);
    if (res.ok) goHome();
  });

  // Save Draft (localStorage)
  document.getElementById("saveDraftBtn").addEventListener("click", () => {
    const data = formToPairs(document.getElementById("updateForm"));
    localStorage.setItem("carepassDraft", JSON.stringify(data));
    showToast("💾 Draft saved locally");
  });
  window.addEventListener("load", () => {
    const draft = localStorage.getItem("carepassDraft");
    if (draft) {
      try {
        const obj = JSON.parse(draft);
        Object.keys(obj).forEach(k => {
          const els = document.querySelectorAll(`[name='${k}']`);
          if (els.length) {
            if (Array.isArray(obj[k])) obj[k].forEach((val,i) => els[i]?.value = val);
            else els[0].value = obj[k];
          }
        });
      } catch {}
    }
  });

  // Doctor Access
  document.getElementById("accessForm").addEventListener("submit", async e => {
    e.preventDefault();
    const data = formToPairs(e.target, { action: "access" });
    const res = await postForm(data);
    const resultDiv = document.getElementById("accessResult");
    resultDiv.classList.remove("hidden");
    if (res.ok && res.record) {
      resultDiv.innerHTML = `<h3 class="font-bold mb-2">Patient Record:</h3><pre>${JSON.stringify(res.record, null, 2)}</pre>`;
      showToast("✅ Record retrieved");
    } else {
      resultDiv.textContent = "❌ " + (res.error || "Not found");
      showToast("❌ Error: " + (res.error || "Not found"), false);
    }
  });
</script>

</body>
</html>
